---
description: Manage patterns.yaml - create if missing, refine if exists, interactive question loop
---

# /phase0:patterns - Pattern Management

**Purpose**: Single command to manage patterns.yaml (THE IDEAL). Creates skeleton if missing, explains and refines if exists.

**Philosophy**: One command, one file, interactive refinement.

---

## Phase 1: Check State

```bash
if [ -f "patterns.yaml" ]; then
  echo "STATUS: patterns.yaml exists"
  echo "SIZE: $(wc -l < patterns.yaml) lines"
  echo "MODIFIED: $(stat -c %y patterns.yaml 2>/dev/null || stat -f %Sm patterns.yaml)"
else
  echo "STATUS: patterns.yaml NOT FOUND"
fi
```

Branch based on result:
- **EXISTS**: Go to Explain + Refine flow
- **MISSING**: Go to Create flow

---

## Flow A: Create (if missing)

### Step 1: Detect Project Type

```bash
# Detect what kind of project this is
[ -f "package.json" ] && echo "Node project detected"
[ -f "pyproject.toml" ] && echo "Python project detected"
[ -f "tsconfig.json" ] && echo "TypeScript detected"
[ -d "apps/api" ] && echo "Monorepo with API detected"
[ -d "apps/web" ] && echo "Monorepo with web detected"
```

### Step 2: Ask Architecture Questions

Use AskUserQuestion to gather info:

1. "What are your main code layers?" (multi-select)
   - core (business logic)
   - apps (delivery)
   - infrastructure (external services)
   - other

2. "What component types do you have?" (multi-select)
   - React components
   - API endpoints
   - Python services
   - Hooks
   - Stores

3. "What testing approach?" (single)
   - Unit tests required
   - Unit + integration
   - Full coverage

### Step 3: Generate Skeleton

Create patterns.yaml with detected + answered info:

```yaml
# patterns.yaml - THE IDEAL
# Generated by /phase0:patterns on [date]
# This file defines what your codebase SHOULD look like.

version: "1.0"
project: "[project-name]"

# Layer boundaries
boundaries:
  python:
    core:
      allow_from: []
      deny_from: [apps, infrastructure]
    # ... based on answers

# Component patterns
component_patterns:
  # ... based on answers

# Anti-patterns to detect
anti_patterns:
  console-log:
    pattern: "console\\.log"
    severity: warning
    message: "Remove before commit"
```

### Step 4: Confirm

Show what will be written, ask for confirmation:

```
## patterns.yaml Preview

[Show YAML content]

Write this file? [Yes] [Edit first] [Cancel]
```

---

## Flow B: Explain + Refine (if exists)

### Step 1: Parse and Summarize

Read patterns.yaml and present summary:

```
## Current patterns.yaml

BOUNDARIES ([count] rules)
├── Python: core → [isolated], apps → [can import core, infra]
└── TypeScript: web ↔ mobile [forbidden]

COMPONENT PATTERNS ([count])
├── react_component: *.tsx + index.ts + *.test.tsx
├── api_endpoint: *.py + ../schemas/*.py
└── ...

ANTI-PATTERNS ([count])
├── console.log (warning)
├── any type (warning)
└── ...

FEATURE TYPES ([count])
├── full_stack: api + schema + component + hook + tests
└── api_only: api + schema + tests
```

### Step 2: Interactive Refinement Loop

Ask what to change (up to 5 rounds):

```
What would you like to change?

[Add boundary rule]
[Add component pattern]
[Add anti-pattern]
[Remove something]
[Done - ship it]
```

For each change:
1. Ask specific questions
2. Show preview of change
3. Confirm before applying

### Step 3: Write Changes

After each confirmed change, update patterns.yaml.

### Step 4: Final Validation

After "Done":
- Check YAML syntax
- Check for conflicts
- Show final summary

```
## patterns.yaml Updated

Changes made:
├── Added boundary: lantern cannot import apps
├── Added anti-pattern: TODO without ticket
└── Modified: react_component now requires stories

Run /phase0:audit to check current compliance.
```

---

## Writes (ONLY this file)

- `patterns.yaml` (project root)

**NEVER writes to**: `ARCHITECTURE.md`, `/.phase0/`, `_templates/`, source code

---

## Question Loop Policy

- Max 5 rounds of questions
- After each round: restate updated understanding
- Stop when: user says "ship it" OR all required info gathered
- Store Q&A in: `/.phase0/reports/patterns-session.md` (optional log)

---

## Validation Checks

Before writing, verify:
- Valid YAML syntax
- No circular boundary dependencies
- All referenced paths use valid patterns
- No conflicting rules

If validation fails, explain and ask for correction.
