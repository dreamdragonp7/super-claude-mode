# ==============================================================================
# patterns.yaml - The Brain of Super Claude Mode
# ==============================================================================
#
# This file defines the IDEAL state of your codebase. Every command reads it,
# every hook checks it, every plugin follows it.
#
# Philosophy: "Don't make the model remember the repo - make the repo tell the model."
#
# Two files tell the complete story:
#   - patterns.yaml (this file) = The Ideal (what SHOULD exist)
#   - ARCHITECTURE.md = The Reality (auto-generated by /audit)
#
# Commands:
#   /planning         - View/manage this file
#   /planning sync    - Auto-discover patterns from codebase
#   /planning add     - Add new pattern interactively
#   /planning validate - Check this file is valid
#   /audit            - Compare reality to this file, generate ARCHITECTURE.md
#   /audit fix        - Auto-generate missing files using Hygen
#
# Copy this template to your project root as `patterns.yaml` and customize.
# Run `/planning sync` to auto-discover patterns from your existing codebase.
#
# ==============================================================================

version: "1.0"
updated: "YYYY-MM-DD"  # Update when you modify this file
project: "your-project-name"

# ==============================================================================
# PYTHON LAYER BOUNDARIES
# ==============================================================================
# Define what Python modules can import from what. This enforces Clean Architecture
# where dependencies flow inward (apps -> core, not core -> apps).
#
# These rules are checked by:
#   - /audit (using import-linter if installed, else grep)
#   - /conform (fixes violations by suggesting refactors)
#
# Install import-linter for real enforcement:
#   pip install import-linter
#   Copy templates/.importlinter to your project root

python_boundaries:
  # Core business logic - should be PURE, no external dependencies
  - name: "Core Business Logic Isolation"
    from: "core/**"
    cannot_import:
      - "apps/**"           # No web/API framework code
      - "infrastructure/**" # No database/external services
    reason: "Core contains domain logic. It should work without any framework."
    severity: error

  # Infrastructure can use core, but not apps
  - name: "Infrastructure Layer"
    from: "infrastructure/**"
    can_import:
      - "core/**"
      - "config/**"
    cannot_import:
      - "apps/**"
    reason: "Infrastructure implements interfaces defined in core."
    severity: error

  # Apps are the outermost layer - can use everything
  - name: "Application Layer"
    from: "apps/**"
    can_import:
      - "core/**"
      - "infrastructure/**"
      - "config/**"
    reason: "Apps wire everything together."
    severity: info

  # Example: ML model isolation (customize for your project)
  # - name: "ML Model Isolation"
  #   from: "ml/**"
  #   cannot_import:
  #     - "apps/**"
  #     - "infrastructure/**"
  #   reason: "ML code should be framework-agnostic for portability."
  #   severity: error

# ==============================================================================
# TYPESCRIPT/JAVASCRIPT BOUNDARIES
# ==============================================================================
# Define what TS/JS packages can import from what. Prevents apps from
# importing each other directly (they should go through shared packages).
#
# These rules are checked by:
#   - /audit (using eslint-plugin-boundaries if configured, else grep)
#
# Install eslint-plugin-boundaries for real enforcement:
#   npm install eslint-plugin-boundaries
#   Copy templates/eslint.boundaries.js to your eslint config

typescript_boundaries:
  packages:
    # Shared code that all apps can use
    - name: "shared"
      pattern: "packages/shared/**"
      type: library
      exports_to: ["web", "mobile", "api"]

    # Web frontend app
    - name: "web"
      pattern: "apps/web/**"
      type: application

    # Mobile app (React Native, etc.)
    - name: "mobile"
      pattern: "apps/mobile/**"
      type: application

    # Backend API (if you have a Node.js backend)
    # - name: "api"
    #   pattern: "apps/api/**"
    #   type: application

  rules:
    - name: "Apps cannot import each other"
      from: ["web"]
      to: ["mobile"]
      allow: false
      reason: "Apps should communicate via shared packages or APIs"
      severity: error

    - name: "Apps cannot import each other (reverse)"
      from: ["mobile"]
      to: ["web"]
      allow: false
      reason: "Apps should communicate via shared packages or APIs"
      severity: error

    - name: "Shared can be imported by apps"
      from: ["shared"]
      to: ["web", "mobile"]
      allow: true

# ==============================================================================
# COMPONENT PATTERNS
# ==============================================================================
# Define what files each type of component should have. /audit checks these
# and /audit fix can auto-generate missing files using Hygen templates.
#
# Common patterns:
#   - React component: Component.tsx, Component.test.tsx, index.ts
#   - API route: route.py, schema.py, test_route.py
#   - Hook: useHook.ts, useHook.test.ts

component_patterns:
  # React/Vue/Svelte components
  react_component:
    path_pattern: "apps/web/src/components/**"
    naming: PascalCase
    required:
      - pattern: "{Name}.tsx"
        description: "Component implementation"
      - pattern: "index.ts"
        description: "Re-export for clean imports"
        must_contain: "export"
    optional:
      - pattern: "{Name}.test.tsx"
        description: "Unit tests"
      - pattern: "{Name}.stories.tsx"
        description: "Storybook stories"
      - pattern: "{Name}.module.css"
        description: "CSS modules"
    # Directories that don't follow this pattern (e.g., UI libraries)
    exceptions:
      - "apps/web/src/components/ui/"  # shadcn components

  # React hooks
  react_hook:
    path_pattern: "apps/web/src/hooks/**"
    naming: camelCase with 'use' prefix
    required:
      - pattern: "use{Name}.ts"
        description: "Hook implementation"
    optional:
      - pattern: "use{Name}.test.ts"
        description: "Unit tests"

  # Python API routes (FastAPI, Flask, etc.)
  api_router:
    path_pattern: "apps/api/routers/**"
    naming: snake_case
    required:
      - pattern: "{name}.py"
        description: "Route handlers"
    related:
      - pattern: "../schemas/{name}.py"
        description: "Request/response schemas"
    tests:
      - pattern: "tests/api/test_{name}.py"
        description: "API tests"

  # Python services/use cases
  python_service:
    path_pattern: "core/**/services/**"
    naming: snake_case
    required:
      - pattern: "{name}.py"
        description: "Service implementation"
    tests:
      - pattern: "tests/unit/test_{name}.py"
        description: "Unit tests"

# ==============================================================================
# FEATURE TYPES
# ==============================================================================
# Define what files each type of feature needs. Used by /phase0 to know what
# boilerplate to generate, and by /audit to check completeness.
#
# When you run `/phase0 add payments feature`, it will:
#   1. Look up the feature type (probably "full-stack")
#   2. Generate all required files using Hygen templates
#   3. Create a task capsule with the file list

feature_types:
  # Full-stack feature: API + Frontend + Database
  - id: full-stack
    name: "Full Stack Feature"
    description: "Feature with backend API, frontend UI, and database"
    files:
      model: "core/models/{name}.py"
      service: "core/services/{name}_service.py"
      route: "apps/api/routers/{name}.py"
      schema: "apps/api/schemas/{name}.py"
      component: "apps/web/src/features/{name}/{Name}.tsx"
      hook: "apps/web/src/features/{name}/use{Name}.ts"
      index: "apps/web/src/features/{name}/index.ts"
    tests:
      api_test: "tests/api/test_{name}.py"
      unit_test: "tests/unit/test_{name}_service.py"
      component_test: "apps/web/src/features/{name}/{Name}.test.tsx"
    hygen_template: "feature new"

  # API-only feature: Just backend, no frontend
  - id: api-only
    name: "API Only Feature"
    description: "Backend-only feature (no frontend)"
    files:
      route: "apps/api/routers/{name}.py"
      schema: "apps/api/schemas/{name}.py"
      service: "core/services/{name}_service.py"
    tests:
      api_test: "tests/api/test_{name}.py"
      unit_test: "tests/unit/test_{name}_service.py"
    hygen_template: "api endpoint"

  # Frontend-only feature: No backend changes
  - id: frontend-only
    name: "Frontend Only Feature"
    description: "Frontend-only feature (uses existing API)"
    files:
      component: "apps/web/src/features/{name}/{Name}.tsx"
      hook: "apps/web/src/features/{name}/use{Name}.ts"
      index: "apps/web/src/features/{name}/index.ts"
    tests:
      component_test: "apps/web/src/features/{name}/{Name}.test.tsx"
    hygen_template: "feature frontend"

  # Add your own feature types here!
  # - id: ml-pipeline
  #   name: "ML Pipeline"
  #   description: "Machine learning pipeline with training, evaluation"
  #   files:
  #     dataset: "data/datasets/{name}/"
  #     training: "ml/training/{name}_trainer.py"
  #     evaluation: "ml/evaluation/{name}_eval.py"
  #   tests:
  #     training_test: "tests/ml/test_{name}_training.py"

# ==============================================================================
# ANTI-PATTERNS
# ==============================================================================
# Patterns to detect and warn about. /audit greps for these and reports them.
# Severity levels:
#   - error: Must fix before merge
#   - warning: Should fix, but not blocking
#   - info: Nice to fix, low priority

anti_patterns:
  # JavaScript/TypeScript anti-patterns
  - id: console-log
    pattern: "console\\.(log|debug|info|warn)\\("
    file_types: [".ts", ".tsx", ".js", ".jsx"]
    message: "Use a proper logger instead of console.log"
    severity: warning
    exclude:
      - "*.test.ts"
      - "*.test.tsx"
      - "*.spec.ts"
    auto_fixable: false

  - id: any-type
    pattern: ":\\s*any(?![a-zA-Z])"
    file_types: [".ts", ".tsx"]
    message: "Avoid 'any' type - use proper types or 'unknown'"
    severity: error
    auto_fixable: false

  - id: deep-relative-import
    pattern: "from ['\"]\\.\\.[\\/]\\.\\.[\\/]\\.\\.[\\/]"
    file_types: [".ts", ".tsx"]
    message: "Avoid deep relative imports - use path aliases (@/)"
    severity: warning
    auto_fixable: false

  # Python anti-patterns
  - id: relative-import
    pattern: "from \\.\\."
    file_types: [".py"]
    message: "Use absolute imports from project root"
    severity: error
    auto_fixable: false

  - id: print-statement
    pattern: "^\\s*print\\("
    file_types: [".py"]
    message: "Use logging instead of print statements"
    severity: warning
    exclude:
      - "*_test.py"
      - "test_*.py"
    auto_fixable: false

  # General anti-patterns
  - id: todo-without-context
    pattern: "TODO(?!.*#|.*:)"
    file_types: ["*"]
    message: "Add context or ticket reference to TODOs (e.g., TODO #123)"
    severity: info
    auto_fixable: false

  - id: commented-code
    pattern: "^\\s*//.*\\{|^\\s*//.*\\}|^\\s*//.*function"
    file_types: [".ts", ".tsx", ".js", ".jsx"]
    message: "Remove commented-out code blocks"
    severity: info
    auto_fixable: false

  # Security anti-patterns
  - id: hardcoded-secret
    pattern: "(password|secret|api_key|apikey)\\s*=\\s*['\"][^'\"]+['\"]"
    file_types: ["*"]
    message: "Possible hardcoded secret - use environment variables"
    severity: error
    exclude:
      - "*.test.*"
      - "*.example.*"
      - ".env.example"
    auto_fixable: false

# ==============================================================================
# DOCUMENTATION REQUIREMENTS
# ==============================================================================
# What documentation files should exist per module/feature.

documentation:
  # Every app should have a README
  modules:
    - path_pattern: "apps/*"
      required:
        - "README.md"

    - path_pattern: "packages/*"
      required:
        - "README.md"

    - path_pattern: "core/*"
      required:
        - "README.md"

  # Features with many files should be documented
  features:
    when_files_exceed: 5
    required:
      - "README.md"

# ==============================================================================
# HYGEN TEMPLATE MAPPINGS
# ==============================================================================
# Map component/feature patterns to Hygen templates for /audit fix.
# These tell /audit fix which Hygen command generates which file.

hygen_mappings:
  react_component:
    new: "component new"
    test: "component test"
    index: "component index"
    stories: "component stories"

  react_hook:
    new: "hook new"
    test: "hook test"

  api_router:
    new: "api endpoint"
    schema: "api schema"
    test: "api test"

  feature:
    full-stack: "feature new"
    api-only: "api endpoint"
    frontend-only: "feature frontend"

  task:
    capsule: "task-capsule new"

# ==============================================================================
# SOURCE OF TRUTH FILES
# ==============================================================================
# Files that define critical contracts. Changes to these should be reviewed carefully.
# /audit warns if these were recently modified.

source_of_truth:
  - path: "patterns.yaml"
    description: "This file - architectural rules"
    lock_level: high

  # Add your project's critical files here:
  # - path: "core/models/schema.py"
  #   description: "Database schema definition"
  #   warning: "Changes may require migrations"
  #   lock_level: high
  #
  # - path: "packages/shared/src/types.ts"
  #   description: "Shared TypeScript types"
  #   warning: "Changes affect all apps"
  #   lock_level: medium
  #
  # - path: "config/settings.py"
  #   description: "Centralized configuration"
  #   lock_level: low

# ==============================================================================
# DEPRECATED PATTERNS
# ==============================================================================
# Files or patterns that should NOT exist. /audit errors if these are found.
# Use this for:
#   - Old code that should have been deleted
#   - Patterns you're migrating away from
#   - Accidental duplicate implementations

deprecated:
  severity: error
  patterns: []
    # Examples:
    # - name: "Old API client"
    #   pattern: "legacyApiClient"
    #   files:
    #     - "src/lib/legacyApi.ts"
    #   reason: "Replaced by new API client in src/lib/api.ts"
    #
    # - name: "Old state management"
    #   pattern: "useOldStore"
    #   files:
    #     - "src/stores/oldStore.ts"
    #   reason: "Migrated to Zustand in src/stores/"

# ==============================================================================
# PROJECT-SPECIFIC PATTERNS
# ==============================================================================
# Add your project's unique patterns here. This section is for anything that
# doesn't fit the above categories.
#
# Examples:
#   - Naming conventions for database migrations
#   - Required environment variables per environment
#   - Feature flag naming patterns
#   - API versioning rules

project_specific:
  # Your custom patterns here
  # migrations:
  #   naming: "YYYY-MM-DD_description.sql"
  #   location: "infrastructure/database/migrations/"
  #
  # feature_flags:
  #   naming: "FF_FEATURE_NAME"
  #   location: "config/feature_flags.py"
