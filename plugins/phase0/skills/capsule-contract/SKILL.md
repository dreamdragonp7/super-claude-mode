---
name: capsule-contract
description: The capsule.yaml contract that all plugins read. Standard schema for cross-plugin handoff.
---

# Capsule Contract

## What Is A Capsule?

A capsule is a YAML file that captures everything needed to hand off context from `/phase0` to other plugins (`/dev-flow`, `/bug-hunt`, `/hygen-rip`).

**Location**: `/.phase0/capsules/<slug>/capsule.yaml`

## Why YAML?

1. **Machine-readable**: Other plugins parse it automatically
2. **Structured**: Clear schema, validated
3. **Diffable**: Easy to track changes in git
4. **Explicit**: No ambiguity about handoff

## Full Schema

```yaml
# Capsule Schema v1.0
# Auto-generated by /phase0 - machines read this

version: "1.0"
created: "2025-01-02T12:00:00Z"
slug: "auth-feature"

# What we're doing
goal: |
  Implement OAuth2 authentication with Google provider,
  including login button, callback handler, and session management.

# What we're NOT doing
non_goals:
  - Multi-provider support (Google only for now)
  - Password-based auth
  - Admin roles

# Hard requirements
constraints:
  - Must use existing session middleware
  - Cannot add new dependencies without approval
  - Must follow patterns.yaml component structure

# How we know we're done
success_criteria:
  - tests_pass: true
  - files_created:
      - apps/api/routers/auth.py
      - apps/api/schemas/auth.py
      - apps/web/src/components/LoginButton/
      - tests/api/test_auth_api.py
  - no_regressions: true
  - boundary_violations: 0

# What was read during /phase0
context:
  patterns_path: "patterns.yaml"
  architecture_path: "ARCHITECTURE.md"
  key_files:
    - path: "apps/api/routers/users.py"
      reason: "Similar auth pattern to follow"
    - path: "apps/api/middleware/session.py"
      reason: "Must integrate with existing sessions"
    - path: "core/features/schema.py"
      reason: "May need new features for auth state"

# Q&A from /phase0
questions:
  decisions_made:
    - question: "Full-stack or API-only?"
      answer: "full-stack"
    - question: "Testing approach?"
      answer: "unit + integration"
  open_questions:
    - "Should we add rate limiting to login endpoint?"

# What to do next
handoff:
  recommended_command: "/dev-flow"
  args: "--capsule auth-feature"
  reasoning: "This is a new feature, not a bug fix"

# What could go wrong
risks:
  - severity: "high"
    description: "Session middleware may need modification"
    mitigation: "Read session.py thoroughly first"
  - severity: "medium"
    description: "Google OAuth callback URL config"
    mitigation: "Test locally before deploying"
```

## How Plugins Read Capsules

### /dev-flow
```python
capsule = yaml.load("/.phase0/capsules/auth-feature/capsule.yaml")
goal = capsule["goal"]
key_files = capsule["context"]["key_files"]
success = capsule["success_criteria"]
```

### /bug-hunt
```python
capsule = yaml.load("/.phase0/capsules/fix-login-bug/capsule.yaml")
# Uses key_files to focus investigation
# Uses constraints to know what NOT to change
```

### /hygen-rip --from-gaps
```python
gaps = json.load("/.phase0/reports/gaps.json")
# Uses gaps to know what to generate
# Doesn't need capsule directly
```

## Capsule Lifecycle

```
1. CREATED     - /phase0 creates capsule.yaml
2. READ        - /dev-flow reads and executes
3. UPDATED     - Progress tracked in capsule (optional)
4. COMPLETED   - success_criteria all checked
5. ARCHIVED    - Stays in git history
```

## Validation Rules

Before writing, /phase0 validates:

1. **Required fields**: version, created, slug, goal, handoff
2. **YAML syntax**: Must parse without errors
3. **Path existence**: key_files paths should exist
4. **Handoff valid**: recommended_command must be known

## Directory Structure

```
/.phase0/
├── capsules/
│   ├── auth-feature/
│   │   ├── capsule.yaml     # Main handoff file
│   │   └── notes.md         # Optional human notes
│   └── fix-login-bug/
│       └── capsule.yaml
└── reports/
    └── gaps.json            # From /phase0:audit
```

## Single Writer

**ONLY /phase0 writes to `/.phase0/`**

Other plugins READ but never write here. This prevents conflicts.
